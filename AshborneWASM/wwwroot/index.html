<!DOCTYPE html>
<html lang="en">

<head>
    <!--
    ASHBORNE WASM ASSET PATHS & GITHUB PAGES DEPLOYMENT
    --------------------------------------------------
    This app is designed to work both locally (localhost) and when hosted on GitHub Pages at a subpath (e.g. /Ashborne/).
    
    - The <base href> is set dynamically at runtime using JS, so all relative asset URLs (css/app.css, Scripts/scroll.js, etc.) resolve correctly.
    - All asset references in HTML, CSS, and Razor files must be RELATIVE (not starting with a slash), so they are resolved relative to the <base href>.
    - Font-face URLs in CSS should use relative paths (e.g. ../visual/fonts/Font.ttf).
    - When publishing for GitHub Pages, no extra changes are needed: just ensure the published files are in the /Ashborne/ subfolder.
    - For local development, everything works as normal with <base href="/">.
    
    If there are to be new static assets, always use relative paths!
    -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Ashborne</title>
        <!--
            IMPORTANT: Set the <base href> for your environment.
            For LOCAL development, use:
                <base href="/" />
            For GITHUB PAGES (https://halfcomplete.github.io/Ashborne/), use:
                <base href="/Ashborne/" />
            You MUST set this BEFORE building/publishing, as browsers resolve all static assets at parse time.
            See below for automation instructions.
        -->
        <base href="/Ashborne/" />
        <!--
        AUTOMATION TIP: To automate this for publish, you can use a pre-publish script or MSBuild target.
        Example PowerShell (run before publish):
            # For GitHub Pages
            (Get-Content index.html) -replace '<base href="/" />', '<base href="/Ashborne/" />' | Set-Content index.html
            # For local development, reverse the replacement.
        Or use MSBuild with a custom target to swap the base href during publish.
        -->
    <script>
        // Debug and force cache refresh for GitHub Pages deployment
        console.log('Current location:', window.location.href);
        console.log('Hostname:', window.location.hostname);
        console.log('Pathname:', window.location.pathname);
        
        // Force reload if we detect we're on GitHub Pages but still accessing localhost
        if (window.location.hostname.endsWith('.github.io') && window.location.href.includes('localhost')) {
            console.log('Detected localhost reference on GitHub Pages, forcing reload...');
            window.location.reload(true);
        }
        
        // Clear any cached data
        if ('caches' in window) {
            caches.keys().then(function(names) {
                console.log('Found caches:', names);
                for (let name of names) {
                    caches.delete(name);
                }
            });
        }
        
        // Force clear localStorage and sessionStorage
        localStorage.clear();
        sessionStorage.clear();
        
        // Unregister any existing service workers
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
    <!--<link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />-->
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="ashborne-icon.png" />
    <link href="AshborneWASM.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
</head>

<body>
    <div id="app">
        <div class="loading-progress-text"></div>
        <div class="loading-progress-bar-container">
            <div class="loading-progress-bar-bg">
                <div class="loading-progress-bar-fill" id="loading-progress-bar-fill"></div>
            </div>
        </div>
        <div class="loading-tip" id="loading-tip"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js?v=1"></script>
    <script>
        //// Register service worker for production
        //if ('serviceWorker' in navigator) {
        //    window.addEventListener('load', function () {
        //        navigator.serviceWorker.register('service-worker.js')
        //            .then(function (registration) {
        //                console.log('ServiceWorker registration successful');
        //            })
        //            .catch(function (err) {
        //                console.log('ServiceWorker registration failed: ', err);
        //            });
        //    });
        //}
        
        // Debug function to test URL resolution
        window.testUrlResolution = function() {
            console.log('Testing URL resolution...');
            console.log('Current location:', window.location.href);
            console.log('Base href:', document.querySelector('base').href);
            
            // Test relative URL resolution
            var testUrl = 'Dialogue/Act1/Scene1/Act1_Scene1_Prisoner_Dialogue.json';
            var resolvedUrl = new URL(testUrl, window.location.href).href;
            console.log('Resolved URL for', testUrl, ':', resolvedUrl);

            // Test fetch
            fetch(testUrl)
                .then(response => {
                    console.log('Fetch successful:', response.status);
                })
                .catch(error => {
                    console.log('Fetch failed:', error);
                });

            // Test relative URL resolution
            testUrl = 'Dialogue/Act1/Scene1/Act1_Scene1_Ossaneth_Domain_Intro.json';
            resolvedUrl = new URL(testUrl, window.location.href).href;
            console.log('Resolved URL for', testUrl, ':', resolvedUrl);
            
            // Test fetch
            fetch(testUrl)
                .then(response => {
                    console.log('Fetch successful:', response.status);
                })
                .catch(error => {
                    console.log('Fetch failed:', error);
                });
        };
        
        // Run test after page loads
        window.addEventListener('load', function() {
            setTimeout(window.testUrlResolution, 1000);
        });

        // Loading bar progress update (simulate or use real value if available)
        window.setLoadingProgress = function(percent) {
            var bar = document.getElementById('loading-progress-bar-fill');
            if (bar) {
                bar.style.width = percent + '%';
            }
        };

        // Tips logic
        (function() {
            var tips = [
                "You can type 'help' at any time for a list of commands â€” if you're allowed to!",
                "Explore every location â€” there may be hidden secrets.",
                "Pay attention to the descriptions. They may contain clues...",
                "You can view your inventory with the command 'inventory'.",
                "Not all dangers can be fought. Sometimes, running is wise.",
                "Use 'look' to re-examine your surroundings.",
                "Some doors require special keys or actions to open.",
                "Watch out for the Eye...",
                "Don't wear Masks for too long..."
            ];
            var shownTips = [];
            var tipDiv = document.getElementById('loading-tip');
            function showRandomTip() {
                if (tips.length === 0) {
                    // Reset pool if all tips shown
                    tips = shownTips;
                    shownTips = [];
                }
                var idx = Math.floor(Math.random() * tips.length);
                var tip = tips.splice(idx, 1)[0];
                shownTips.push(tip);
                if (tipDiv) tipDiv.textContent = tip;
            }
            showRandomTip();
            setInterval(showRandomTip, 4000);
        })();
    </script>
    <script src="Scripts/scroll.js"></script>
</body>

</html>
